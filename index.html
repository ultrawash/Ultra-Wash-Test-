<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ultra Wash Customer Form</title>
<style>
:root {
  --font-family: 'Open Sans', sans-serif;
  --font-size-label: 14px;
  --font-size-input: 14px;
  --font-size-header: 22px;
  --color-background: #f6f7fa;
  --color-card-bg: #ffffff;
  --color-card-border: #dbdfe7;
  --color-card-shadow: rgba(99, 77, 255, 0.06);
  --color-header: #333;
  --color-label: #555;
  --color-input-border: #ccc;
  --color-input-text: #333;
  --color-focus-border: #5a4cc2;
  --color-btn-bg: #ff6d5a;
  --color-btn-text: #fff;
  --radius: 6px;
  --container-width: 440px;
  --color-valid: #4caf50;
}
body {
  font-family: var(--font-family);
  background-color: var(--color-background);
  display: flex;
  justify-content: center;
  padding: 32px;
}
form {
  background: var(--color-card-bg);
  border: 1px solid var(--color-card-border);
  border-radius: var(--radius);
  box-shadow: 0 4px 12px var(--color-card-shadow);
  padding: 24px;
  width: var(--container-width);
}
h1 {
  text-align: center;
  font-size: var(--font-size-header);
  color: var(--color-header);
  margin-bottom: 24px;
}
label {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
  font-size: var(--font-size-label);
}
input[type="text"],
input[type="tel"],
input[type="datetime-local"],
input[type="number"],
textarea,
select {
  width: 100%;
  padding: 10px;
  font-size: var(--font-size-input);
  border: 1px solid var(--color-input-border);
  border-radius: var(--radius);
  margin-bottom: 16px;
  box-sizing: border-box;
  transition: border-color 0.2s, box-shadow 0.2s;
}
input:focus,
textarea:focus,
select:focus {
  outline: none;
  border-color: var(--color-focus-border);
  box-shadow: 0 0 4px var(--color-focus-border);
}
/* Green border for filled fields */
input:not(:placeholder-shown):valid,
textarea:not(:placeholder-shown):valid,
select:valid {
  border-color: var(--color-valid);
}
textarea { resize: vertical; }
button[type="submit"] {
  background-color: var(--color-btn-bg);
  color: var(--color-btn-text);
  border: none;
  padding: 12px;
  width: 100%;
  border-radius: var(--radius);
  font-weight: 600;
  font-size: var(--font-size-input);
  cursor: pointer;
  margin-bottom: 16px;
}
button[type="submit"]:hover { background-color: #e05343; }
.note { font-size: 13px; color: #555; margin: 4px 0 16px 0; line-height: 1.4; }
.small-checkbox-label { font-size: 13px; margin-left: 4px; }
#thankYouPopup {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: rgba(0,0,0,0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}
#thankYouPopup .popup-content {
  background: white;
  border-radius: 12px;
  padding: 24px 16px;
  max-width: 320px;
  text-align: center;
  box-shadow: 0 6px 20px rgba(0,0,0,0.1);
}
#thankYouPopup .checkmark { font-size: 48px; color: #4CAF50; margin-bottom: 16px; }
#thankYouPopup h1 { font-size: 20px; margin-bottom: 12px; color: #222; }
#thankYouPopup p { font-size: 15px; color: #555; line-height: 1.6; margin: 0; }
#thankYouPopup button {
  margin-top: 20px;
  background-color: #ff6d5a;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
}
#sameAsPickupWrapper { margin-bottom: 8px; }
.same-as-active { margin-bottom: 40px; }
.pricing-details {
  background-color: #f9f9f9;
  border-left: 4px solid #5a4cc2;
  padding: 10px;
  margin-bottom: 16px;
  border-radius: 4px;
}
.auto-filled {
  background-color: #f0f7ff;
  border-left: 4px solid #4a90e2;
}
.membership-usage {
  background-color: #f8f9fa;
  border-left: 4px solid #4a90e2;
  padding: 15px;
  margin-bottom: 16px;
  border-radius: 4px;
}
.membership-usage h3 {
  margin-top: 0;
  margin-bottom: 15px;
  color: #2c3e50;
  font-size: 16px;
}

/* NEW: Custom dropdown styles */
.custom-dropdown {
  position: relative;
  margin-bottom: 16px;
}

.dropdown-select {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px;
  border: 1px solid var(--color-input-border);
  border-radius: var(--radius);
  cursor: pointer;
  background-color: white;
  font-size: var(--font-size-input); /* Ensure same font size */
}

.dropdown-select:after {
  content: "▼";
  font-size: 12px;
  transition: transform 0.2s;
}

.dropdown-select.open:after {
  transform: rotate(180deg);
}

.dropdown-search {
  width: 100%;
  padding: 10px;
  border: 1px solid var(--color-input-border);
  border-radius: var(--radius);
  margin-bottom: 8px;
  box-sizing: border-box;
  display: none;
  font-size: var(--font-size-input); /* Ensure same font size */
}

.dropdown-options {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  max-height: 200px;
  overflow-y: auto;
  border: 1px solid var(--color-input-border);
  border-radius: var(--radius);
  background: white;
  z-index: 100;
  display: none;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.dropdown-options.open {
  display: block;
}

.dropdown-option {
  padding: 10px;
  cursor: pointer;
  border-bottom: 1px solid #f0f0f0;
  font-size: var(--font-size-input); /* Ensure same font size */
}

.dropdown-option:last-child {
  border-bottom: none;
}

.dropdown-option:hover {
  background-color: #f6f7fa;
}

.dropdown-option.selected {
  background-color: #e6f7ff;
  font-weight: 600;
}

/* Scrollable select styling */
.scrollable-select {
  max-height: 200px;
  overflow-y: auto;
  border: 1px solid var(--color-input-border);
  border-radius: var(--radius);
  margin-bottom: 16px;
}
.scrollable-select select {
  border: none;
  margin-bottom: 0;
}
.scrollable-select select:focus {
  outline: none;
  box-shadow: none;
}

/* Hidden backend address styling */
.backend-address {
  display: none !important;
}
  
  /* Add your placeholder fix here! */
input::placeholder,
textarea::placeholder {
  font-family: var(--font-family);
  font-size: var(--font-size-input);
  color: #bbb;
  opacity: 1;
}
</style>
</head>
<body>

<!-- Remove the action attribute and let JavaScript handle submission -->
<form id="appointmentForm" novalidate>
  <h1>Ultra Wash Customer Form</h1>

  <!-- Form Type Selection -->
  <label for="formMode">Form Type</label>
  <select id="formMode" name="formMode" required>
    <option value="" disabled selected>Select Form Type</option>
    <option value="customer">Customer Form</option>
    <option value="update">Update Form</option>
  </select>

  <!-- Customer Form -->
  <div id="customerForm" style="display:none;">
    <label for="name">Full Name</label>
    <input id="name" name="name" type="text" placeholder="First Name, Last Name" required />

    <label for="phone">Phone Number</label>
    <input id="phone" name="phone" type="tel" placeholder="+673 8221133 / 8221133" required />

    <!-- Service Package Field -->
    <label for="pricingService">Service Package</label>
    <select id="pricingService" name="pricingService" required>
      <option value="" disabled selected>-- Select Package --</option>
      <option value="membership">Membership</option>
      <option value="jimat">Jimat Cuci Bersama</option>
      <option value="wash">Wash, Dry & Fold</option>
      <option value="folding">Folding</option>
      <option value="ironing">Ironing</option>
    </select>

    <!-- Membership options -->
    <div id="membershipFields" style="display:none;">
      <label for="membershipPlan">Membership Plan</label>
      <select id="membershipPlan" name="membershipPlan" required>
        <option value="" disabled selected>-- Select Plan --</option>
        <option value="120-12-60">$120 – 12 trips (60kg)</option>
        <option value="100-2-50">$100 – 2x/week (max 50kg, 1 address)</option>
      </select>
    </div>

    <!-- Jimat options -->
    <div id="jimatFields" style="display:none;">
      <label for="jimatPlan">Jimat Cuci Bersama</label>
      <select id="jimatPlan" name="jimatPlan" required>
        <option value="" disabled selected>-- Select Box --</option>
        <option value="16">$16 / 1 box</option>
        <option value="28">$28 / 2 boxes</option>
        <option value="40">$40 / 4 boxes</option>
      </select>
    </div>

    <!-- Static Price Display (No Live Calculation) -->
    <div class="note"><strong>Price will be calculated after selection</strong></div>

    <label for="service">Service</label>
    <select id="service" name="service" required>
      <option value="" disabled selected>Select service</option>
      <option value="Self Drop-off & Pick Up">Self Drop-off & Pick Up</option>
      <option value="Pick Up Only">Pick Up Only</option>
      <option value="Delivery Only">Delivery Only</option>
      <option value="Pick Up & Delivery">Pick Up & Delivery</option>
    </select>

    <div id="serviceFields" style="display:none;">
      <div id="singleAddressSection" style="display:none;">
        <label id="singleAddressLabel">Address</label>
        <textarea id="singleAddress" name="singleAddress" placeholder="Enter your Address" rows="3" required></textarea>
        <label for="singleMapLink">Map Link</label>
        <input id="singleMapLink" name="singleMapLink" type="text" placeholder="Paste Google Maps link or Coordinates" required />
        <label id="singleDateLabel">Date & Time</label>
        <div class="note" id="singleDateNote"></div>
        <input type="datetime-local" id="singleDateTime" name="singleDateTime" required />
        <input type="hidden" id="singleDateFormatted" name="singleDateFormatted">
      </div>

      <div id="pickUpDeliverySection" style="display:none;">
        <label>Pick Up Location</label>
        <textarea id="pickupAddress" name="pickupAddress" placeholder="Enter your Address" rows="3" required></textarea>
        <label for="pickupMapLink">Map Link</label>
        <input id="pickupMapLink" name="pickupMapLink" type="text" placeholder="Paste Google Maps link" required />
        <label>Pick Up Date & Time</label>
        <div class="note">⏰ Pick Up hours:<br>• Monday–Friday: 08:30 AM – 04:30 PM<br>• Saturday: 08:30 AM – 11:30 AM<br>• Sunday: Closed</div>
        <input type="datetime-local" id="pickupDate" name="pickupDate" required />
        <input type="hidden" id="pickupDateFormatted" name="pickupDateFormatted">

        <label>Delivery Location</label>
        <div id="sameAsPickupWrapper">
          <input type="checkbox" id="sameAsPickup"> 
          <span class="small-checkbox-label">Delivery address same as Pickup</span>
        </div>
        <textarea id="deliveryAddress" name="deliveryAddress" placeholder="Enter your Address" rows="3" required></textarea>
        <label for="deliveryMapLink" id="deliveryMapLabel">Map Link</label>
        <input id="deliveryMapLink" name="deliveryMapLink" type="text" placeholder="Paste Google Maps link" required />
        <div id="deliveryDateSection" style="display:none;">
          <label>Delivery Date & Time</label>
          <div class="note">⏰ Delivery hours:<br>• Monday–Friday: 08:30 AM – 04:30 PM<br>• Saturday: 08:30 AM – 11:30 AM<br>• Sunday: Closed</div>
          <input type="datetime-local" id="deliveryDate" name="deliveryDate" required />
          <input type="hidden" id="deliveryDateFormatted" name="deliveryDateFormatted">
        </div>
      </div>
    </div>
  </div>

  <!-- Update Form (Worker Form) -->
  <div id="updateForm" style="display:none;">
    <label for="customerRef">Customer Reference (Phone/ID)</label>
    
    <!-- NEW: Custom dropdown implementation -->
    <div class="custom-dropdown" id="customerRefDropdown">
      <div class="dropdown-select" id="customerRefSelect">
        <span>Select Customer</span>
      </div>
      <input type="text" class="dropdown-search" id="customerRefSearch" placeholder="Search customers...">
      <div class="dropdown-options" id="customerRefOptions"></div>
      <input type="hidden" id="customerRef" name="customerRef" required>
    </div>

    <!-- Hidden Phone Number (for backend only) -->
    <input id="customerPhoneWorker" name="customerPhoneWorker" type="hidden" />

    <!-- Hidden Backend Address (for backend only) -->
    <input id="backendAddress" name="backendAddress" type="hidden" />
    <label for="mapLinkWorker">Map Link</label>
    <input id="mapLinkWorker" name="mapLinkWorker" type="text" readonly placeholder="Auto-filled from Customer Data" class="auto-filled" />

    <label for="serviceWorker">Service Type</label>
    <input id="serviceWorker" name="serviceWorker" type="text" readonly placeholder="Auto-filled from Customer Data" class="auto-filled" />

    <!-- Hidden Customer Name -->
    <input id="customerNameWorker" name="customerNameWorker" type="hidden" />

    <!-- Service Package Field for Update Form (Readonly) -->
    <label for="pricingServiceUpdate">Service Package</label>
    <input id="pricingServiceUpdateDisplay" name="pricingServiceUpdateDisplay" type="text" readonly class="auto-filled" />
    <input id="pricingServiceUpdate" name="pricingServiceUpdate" type="hidden" />

    <!-- Update Form Pricing Fields -->
    <div id="membershipFieldsUpdate" style="display:none;">
      <label for="membershipPlanUpdate">Membership Plan</label>
      <select id="membershipPlanUpdate" name="membershipPlanUpdate" disabled>
        <option value="" disabled selected>-- Select Plan --</option>
        <option value="120-12-60">$120 – 12 trips (60kg)</option>
        <option value="100-2-50">$100 – 2x/week (max 50kg, 1 address)</option>
      </select>
    </div>

    <div id="jimatFieldsUpdate" style="display:none;">
      <label for="jimatPlanUpdate">Jimat Cuci Bersama</label>
      <select id="jimatPlanUpdate" name="jimatPlanUpdate" disabled>
        <option value="" disabled selected>-- Select Box --</option>
        <option value="16">$16 / 1 box</option>
        <option value="28">$28 / 2 boxes</option>
        <option value="40">$40 / 4 boxes</option>
      </select>
    </div>

    <div id="washFieldsUpdate" style="display:none;">
      <label for="washKgUpdate">Weight (kg)</label>
      <input type="number" id="washKgUpdate" name="washKgUpdate" min="1" step="1" required />
    </div>

    <div id="foldingFieldsUpdate" style="display:none;">
      <label for="foldKgUpdate">Weight (kg)</label>
      <input type="number" id="foldKgUpdate" name="foldKgUpdate" min="1" step="1" required />
    </div>

    <div id="ironingFieldsUpdate" style="display:none;">
      <label for="ironPcsUpdate">Number of Pieces</label>
      <input type="number" id="ironPcsUpdate" name="ironPcsUpdate" min="1" step="1" required />
    </div>

    <!-- Membership Usage Tracking (Only shown for membership customers) -->
    <div id="membershipUsageSection" class="membership-usage" style="display:none;">
      <h3>Membership Usage</h3>
      <label for="tripsUsed">Trips Used</label>
      <input type="number" id="tripsUsed" name="tripsUsed" min="0" step="1" value="1" required />
      
      <label for="weightUsed">Weight Used (Kg)</label>
      <input type="number" id="weightUsed" name="weightUsed" min="0" step="0.1" required />
      
      <!-- Membership Balance Display -->
      <div id="membershipBalance" style="margin-top: 10px; padding: 10px; background-color: #e8f4fc; border-radius: 4px;">
        <strong>Current Balance:</strong><br>
        <span id="tripsBalance">Trips Remaining: --</span><br>
        <span id="weightBalance">Weight Remaining: -- kg</span>
      </div>
    </div>

    <!-- Live Calculation for Update Form (Hidden for membership) -->
    <div id="pricingDetailsUpdate" class="pricing-details" style="display:none;">
      <strong>Total Price: <span id="totalPriceUpdate">--</span></strong><br>
      <strong>Price Breakdown: <span id="priceBreakdownUpdate">--</span></strong>
    </div>

    <label for="totalItems">Total Items</label>
    <input id="totalItems" name="totalItems" type="number" min="1" placeholder="Enter total items" required />
  </div>

  <button type="submit">Submit</button>
</form>

<div id="thankYouPopup">
  <div class="popup-content">
    <div class="checkmark">✅</div>
    <h1>Thank you!</h1>
    <p>Form has been successfully submitted.<br>Please update accordingly.</p>
    <button onclick="closePopup()">Close</button>
  </div>
</div>

<script>
// Global variables to store membership balance and customers
let currentTripsBalance = 0;
let currentWeightBalance = 0;
let allCustomers = [];

const formMode = document.getElementById('formMode');
const customerForm = document.getElementById('customerForm');
const updateForm = document.getElementById('updateForm');
const serviceSelect = document.getElementById('service');
const serviceFields = document.getElementById('serviceFields');
const singleAddressSection = document.getElementById('singleAddressSection');
const pickUpDeliverySection = document.getElementById('pickUpDeliverySection');
const sameAsPickup = document.getElementById('sameAsPickup');
const sameAsPickupWrapper = document.getElementById('sameAsPickupWrapper');
const deliveryAddress = document.getElementById('deliveryAddress');
const deliveryMapLink = document.getElementById('deliveryMapLink');
const deliveryMapLabel = document.getElementById('deliveryMapLabel');

// NEW: Custom dropdown elements
const customerRefDropdown = document.getElementById('customerRefDropdown');
const customerRefSelect = document.getElementById('customerRefSelect');
const customerRefSearch = document.getElementById('customerRefSearch');
const customerRefOptions = document.getElementById('customerRefOptions');
const customerRefHidden = document.getElementById('customerRef');

// Switch form modes
formMode.addEventListener('change', () => {
  if(formMode.value === 'customer'){
    customerForm.style.display = 'block';
    updateForm.style.display = 'none';
    serviceFields.style.display = 'none';
  } else if(formMode.value === 'update'){
    customerForm.style.display = 'none';
    updateForm.style.display = 'block';
  }
});

// Service selection
serviceSelect.addEventListener('change', () => {
  serviceFields.style.display = 'block';
  if(serviceSelect.value === 'Self Drop-off & Pick Up'){
    singleAddressSection.style.display = 'none';
    pickUpDeliverySection.style.display = 'none';
  } else if(serviceSelect.value === 'Pick Up Only'){
    singleAddressSection.style.display = 'block';
    pickUpDeliverySection.style.display = 'none';
    document.getElementById('singleDateLabel').textContent = 'Pick Up Date & Time';
    document.getElementById('singleDateNote').innerHTML = `⏰ Pick Up hours:<br>• Monday–Friday: 08:30 AM – 04:30 PM<br>• Saturday: 08:30 AM – 11:30 AM<br>• Sunday: Closed`;
  } else if(serviceSelect.value === 'Delivery Only'){
    singleAddressSection.style.display = 'block';
    pickUpDeliverySection.style.display = 'none';
    document.getElementById('singleDateLabel').textContent = 'Delivery Date & Time';
    document.getElementById('singleDateNote').innerHTML = `⏰ Delivery hours:<br>• Monday–Friday: 08:30 AM – 04:30 PM<br>• Saturday: 08:30 AM – 11:30 AM<br>• Sunday: Closed`;
  } else if(serviceSelect.value === 'Pick Up & Delivery'){
    singleAddressSection.style.display = 'none';
    pickUpDeliverySection.style.display = 'block';
    sameAsPickup.checked = false;
    deliveryAddress.style.display = 'block';
    deliveryMapLink.style.display = 'block';
    deliveryMapLabel.style.display = 'block';
    document.getElementById('deliveryDateSection').style.display = 'block';
    sameAsPickupWrapper.classList.remove('same-as-active');
  }
});

// Delivery same as pickup toggle
sameAsPickup.addEventListener('change', () => {
  if(sameAsPickup.checked){
    deliveryAddress.style.display = 'none';
    deliveryMapLink.style.display = 'none';
    deliveryMapLabel.style.display = 'none';
    document.getElementById('deliveryDateSection').style.display = 'none';
    sameAsPickupWrapper.classList.add('same-as-active');
  } else {
    deliveryAddress.style.display = 'block';
    deliveryMapLink.style.display = 'block';
    deliveryMapLabel.style.display = 'block';
    document.getElementById('deliveryDateSection').style.display = 'block';
    sameAsPickupWrapper.classList.remove('same-as-active');
  }
});

// Close popup
function closePopup(){ 
  document.getElementById('thankYouPopup').style.display='none'; 
  // Optionally reset the form after successful submission
  document.getElementById('appointmentForm').reset();
  // Reset form visibility
  customerForm.style.display = 'none';
  updateForm.style.display = 'none';
  serviceFields.style.display = 'none';
  singleAddressSection.style.display = 'none';
  pickUpDeliverySection.style.display = 'none';
  formMode.selectedIndex = 0;
}

// Function to update membership balance in real-time
function updateMembershipBalance() {
  const tripsUsed = parseInt(document.getElementById("tripsUsed").value) || 0;
  const weightUsed = parseFloat(document.getElementById("weightUsed").value) || 0;
  
  // Calculate remaining values using the stored balance values
  const tripsRemaining = currentTripsBalance - tripsUsed;
  const weightRemaining = currentWeightBalance - weightUsed;
  
  // Update the display with remaining values
  document.getElementById("tripsBalance").textContent = `Trips Remaining: ${tripsRemaining >= 0 ? tripsRemaining : 0}`;
  document.getElementById("weightBalance").textContent = `Weight Remaining: ${weightRemaining >= 0 ? weightRemaining.toFixed(1) : 0} kg`;
}

// Function to load membership balance from Google Apps Script
async function loadMembershipBalance(phoneNumber) {
  try {
    const response = await fetch(`https://script.google.com/macros/s/AKfycbwRk-T3xGVFx0PzQSXqJ9piRLk8tXUWzcyDDHOfCxDuhLJ1V2PAPt87LETLZ1ZkbpnZmA/exec?type=membership&phone=${encodeURIComponent(phoneNumber)}`);
    const membershipData = await response.json();
    
    // Check if there's an error in the response
    if (membershipData.error) {
      console.error("Error from server:", membershipData.error);
      document.getElementById("tripsBalance").textContent = "Error loading balance";
      document.getElementById("weightBalance").textContent = "Error loading balance";
      return;
    }
    
    if (membershipData && membershipData.balance) {
      // Store the actual balance values in variables
      currentTripsBalance = parseInt(membershipData.balance.trips) || 0;
      currentWeightBalance = parseFloat(membershipData.balance.weight) || 0;
      
      // Display the initial balance
      document.getElementById("tripsBalance").textContent = `Trips Remaining: ${currentTripsBalance}`;
      document.getElementById("weightBalance").textContent = `Weight Remaining: ${currentWeightBalance} kg`;
      
      // Add event listeners to update balance when values change
      document.getElementById("tripsUsed").addEventListener("input", updateMembershipBalance);
      document.getElementById("weightUsed").addEventListener("input", updateMembershipBalance);
      
      // Set initial values for trips and weight used
      document.getElementById("tripsUsed").value = "1";
      document.getElementById("weightUsed").value = "";
    } else {
      document.getElementById("tripsBalance").textContent = "Trips Remaining: --";
      document.getElementById("weightBalance").textContent = "Weight Remaining: -- kg";
    }
  } catch (err) {
    console.error("Error loading membership balance:", err);
    document.getElementById("tripsBalance").textContent = "Trips Remaining: Error loading";
    document.getElementById("weightBalance").textContent = "Weight Remaining: Error loading";
  }
}

// NEW: Custom dropdown functionality
function setupCustomDropdown() {
  // Toggle dropdown visibility
  customerRefSelect.addEventListener('click', function(e) {
    e.stopPropagation();
    customerRefDropdown.classList.toggle('open');
    customerRefSearch.style.display = customerRefDropdown.classList.contains('open') ? 'block' : 'none';
    customerRefOptions.classList.toggle('open');
    
    if (customerRefDropdown.classList.contains('open')) {
      customerRefSearch.focus();
    }
  });
  
  // Filter options when typing in search
  customerRefSearch.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const options = customerRefOptions.querySelectorAll('.dropdown-option');
    
    options.forEach(option => {
      const text = option.textContent.toLowerCase();
      option.style.display = text.includes(searchTerm) ? 'block' : 'none';
    });
  });
  
  // Close dropdown when clicking outside
  document.addEventListener('click', function(e) {
    if (!customerRefDropdown.contains(e.target)) {
      customerRefDropdown.classList.remove('open');
      customerRefSearch.style.display = 'none';
      customerRefOptions.classList.remove('open');
    }
  });
  
  // Prevent closing when clicking inside dropdown
  customerRefDropdown.addEventListener('click', function(e) {
    e.stopPropagation();
  });
}

// NEW: Populate custom dropdown with customers
function populateCustomDropdown(customers) {
  customerRefOptions.innerHTML = '';
  
  customers.forEach(cust => {
    const option = document.createElement('div');
    option.className = 'dropdown-option';
    option.textContent = `${cust["Name"]} (${cust["Customer ID"]})`;
    option.dataset.value = cust["Customer ID"] || cust["Phone"];
    option.dataset.maplink = cust["Map Link / Coordinates"];
    option.dataset.address = cust["Location Address"];
    option.dataset.service = cust["Service Type"] || "";
    option.dataset.name = cust["Name"];
    option.dataset.phone = cust["Phone"];
    option.dataset.package = cust["Service Package"] || "";
    option.dataset.plan = cust["Plan Details"] || "";
    option.dataset.quantity = cust["Quantity"] || "";
    
    option.addEventListener('click', function() {
      // Update selected value
      customerRefHidden.value = this.dataset.value;
      customerRefSelect.querySelector('span').textContent = this.textContent;
      
      // Close dropdown
      customerRefDropdown.classList.remove('open');
      customerRefSearch.style.display = 'none';
      customerRefOptions.classList.remove('open');
      
      // Remove previous selections
      customerRefOptions.querySelectorAll('.dropdown-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      
      // Highlight selected option
      this.classList.add('selected');
      
      // Auto-fill other fields
      document.getElementById("mapLinkWorker").value = this.dataset.maplink || "";
      document.getElementById("serviceWorker").value = this.dataset.service || "";
      document.getElementById("customerNameWorker").value = this.dataset.name || "";
      document.getElementById("customerPhoneWorker").value = this.dataset.phone || "";
      document.getElementById("backendAddress").value = this.dataset.address || "";
      
      // Auto-fill service package and pricing details
      if (this.dataset.package) {
        const packageValue = this.dataset.package;
        const packageDisplay = getPackageDisplayName(packageValue);
        
        document.getElementById("pricingServiceUpdateDisplay").value = packageDisplay;
        document.getElementById("pricingServiceUpdate").value = packageValue;
        
        showPricingFieldsUpdate();
        
        // Show/hide membership usage section based on package type
        if (packageValue === "membership") {
          document.getElementById("membershipUsageSection").style.display = "block";
          document.getElementById("pricingDetailsUpdate").style.display = "none"; // Hide pricing for membership
          
          // Load membership balance
          loadMembershipBalance(this.dataset.phone);
        } else {
          document.getElementById("membershipUsageSection").style.display = "none";
          document.getElementById("pricingDetailsUpdate").style.display = "block"; // Show pricing for non-membership
          
          // Remove event listeners if they exist
          document.getElementById("tripsUsed").removeEventListener("input", updateMembershipBalance);
          document.getElementById("weightUsed").removeEventListener("input", updateMembershipBalance);
        }
        
        // Auto-fill plan details based on package type
        if (packageValue === "membership" && this.dataset.plan) {
          document.getElementById("membershipPlanUpdate").value = this.dataset.plan;
        } else if (packageValue === "jimat" && this.dataset.plan) {
          document.getElementById("jimatPlanUpdate").value = this.dataset.plan;
        } else if (packageValue === "wash" && this.dataset.quantity) {
          document.getElementById("washKgUpdate").value = this.dataset.quantity;
        } else if (packageValue === "folding" && this.dataset.quantity) {
          document.getElementById("foldKgUpdate").value = this.dataset.quantity;
        } else if (packageValue === "ironing" && this.dataset.quantity) {
          document.getElementById("ironPcsUpdate").value = this.dataset.quantity;
        }
        
        // Calculate price after auto-filling (for non-membership packages)
        if (packageValue !== "membership") {
          calcPriceUpdate();
        }
      } else {
        // If no package data, clear the fields
        document.getElementById("pricingServiceUpdateDisplay").value = "";
        document.getElementById("pricingServiceUpdate").value = "";
        document.getElementById("membershipUsageSection").style.display = "none";
        document.getElementById("pricingDetailsUpdate").style.display = "none";
        hideAllPricingUpdate();
      }
    });
    
    customerRefOptions.appendChild(option);
  });
}

// Load customer list from Google Apps Script
async function loadCustomers() {
  try {
    const response = await fetch("https://script.google.com/macros/s/AKfycbwRk-T3xGVFx0PzQSXqJ9piRLk8tXUWzcyDDHOfCxDuhLJ1V2PAPt87LETLZ1ZkbpnZmA/exec");
    allCustomers = await response.json();
    
    // Set up custom dropdown
    setupCustomDropdown();
    populateCustomDropdown(allCustomers);

  } catch (err) {
    console.error("Error loading customers:", err);
  }
}

// Helper function to get display name for package
function getPackageDisplayName(value) {
  const packages = {
    "membership": "Membership",
    "jimat": "Jimat Cuci Bersama",
    "wash": "Wash, Dry & Fold",
    "folding": "Folding",
    "ironing": "Ironing"
  };
  return packages[value] || value;
}

window.addEventListener("DOMContentLoaded", loadCustomers);

// Function to get Brunei formatted date/time
function getBruneiFormattedDateTime(inputId) {
  const dt = document.getElementById(inputId).valueAsDate || new Date();
  return dt.toLocaleString("en-US", {
    timeZone: "Asia/Brunei",
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
    hour12: true
  });
}

// Function to check if selected time is within business hours
function isWithinBusinessHours(dateTime, isPickup = true) {
  const date = new Date(dateTime);
  const day = date.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
  const hours = date.getHours();
  const minutes = date.getMinutes();
  
  // Sunday is closed
  if (day === 0) return false;
  
  // Monday to Friday
  if (day >= 1 && day <= 5) {
    const timeInMinutes = hours * 60 + minutes;
    const startTime = 8 * 60 + 30; // 8:30 AM
    const endTime = 16 * 60 + 30;  // 4:30 PM
    
    return timeInMinutes >= startTime && timeInMinutes <= endTime;
  }
  
  // Saturday
  if (day === 6) {
    const timeInMinutes = hours * 60 + minutes;
    const startTime = 8 * 60 + 30; // 8:30 AM
    const endTime = 11 * 60 + 30;  // 11:30 AM
    
    return timeInMinutes >= startTime && timeInMinutes <= endTime;
  }
  
  return false;
}

// Function to validate datetime inputs
function validateDateTimeInputs() {
  let isValid = true;
  
  // Check if we're in customer form
  if (formMode.value === 'customer') {
    const serviceType = serviceSelect.value;
    
    if (serviceType === 'Pick Up Only') {
      const pickupDateTime = document.getElementById('singleDateTime');
      if (pickupDateTime.value && !isWithinBusinessHours(pickupDateTime.value, true)) {
        alert('Selected pick-up time is outside business hours. Please select a time between Monday-Friday 8:30 AM - 4:30 PM or Saturday 8:30 AM - 11:30 AM.');
        pickupDateTime.focus();
        isValid = false;
      }
    } else if (serviceType === 'Delivery Only') {
      const deliveryDateTime = document.getElementById('singleDateTime');
      if (deliveryDateTime.value && !isWithinBusinessHours(deliveryDateTime.value, false)) {
        alert('Selected delivery time is outside business hours. Please select a time between Monday-Friday 8:30 AM - 4:30 PM or Saturday 8:30 AM - 11:30 AM.');
        deliveryDateTime.focus();
        isValid = false;
      }
    } else if (serviceType === 'Pick Up & Delivery') {
      const pickupDate = document.getElementById('pickupDate');
      if (pickupDate.value && !isWithinBusinessHours(pickupDate.value, true)) {
        alert('Selected pick-up time is outside business hours. Please select a time between Monday-Friday 8:30 AM - 4:30 PM or Saturday 8:30 AM - 11:30 AM.');
        pickupDate.focus();
        isValid = false;
      }
      
      const deliveryDate = document.getElementById('deliveryDate');
      if (deliveryDate.value && !isWithinBusinessHours(deliveryDate.value, false)) {
        alert('Selected delivery time is outside business hours. Please select a time between Monday-Friday 8:30 AM - 4:30 PM or Saturday 8:30 AM - 11:30 AM.');
        deliveryDate.focus();
        isValid = false;
      }
    }
  }
  
  return isValid;
}

// Add event listeners to datetime inputs to check business hours
function addBusinessHoursValidation() {
  const datetimeInputs = [
    document.getElementById('singleDateTime'),
    document.getElementById('pickupDate'),
    document.getElementById('deliveryDate')
  ];
  
  datetimeInputs.forEach(input => {
    if (input) {
      input.addEventListener('change', function() {
        if (this.value) {
          const isPickup = this.id !== 'deliveryDate';
          if (!isWithinBusinessHours(this.value, isPickup)) {
            alert('Warning: The selected time is outside of business hours. Please select a time during our operating hours.');
          }
        }
      });
    }
  });
}

// === Pricing logic for Customer Form ===
const pricingService = document.getElementById('pricingService');
const membershipFields = document.getElementById('membershipFields');
const jimatFields = document.getElementById('jimatFields');

// Hide all pricing fields initially
function hideAllPricingCustomer() {
  [membershipFields, jimatFields].forEach(div => div.style.display = 'none');
}

// Show only membership and jimat fields for customer form
pricingService.addEventListener('change', () => {
  hideAllPricingCustomer();
  if(pricingService.value==='membership') membershipFields.style.display='block';
  if(pricingService.value==='jimat') jimatFields.style.display='block';
});

// === Pricing logic for Update Form ===
const totalPriceUpdateEl = document.getElementById('totalPriceUpdate');
const membershipFieldsUpdate = document.getElementById('membershipFieldsUpdate');
const jimatFieldsUpdate = document.getElementById('jimatFieldsUpdate');
const washFieldsUpdate = document.getElementById('washFieldsUpdate');
const foldingFieldsUpdate = document.getElementById('foldingFieldsUpdate');
const ironingFieldsUpdate = document.getElementById('ironingFieldsUpdate');
const membershipPlanUpdate = document.getElementById('membershipPlanUpdate');
const jimatPlanUpdate = document.getElementById('jimatPlanUpdate');
const washKgUpdate = document.getElementById('washKgUpdate');
const foldKgUpdate = document.getElementById('foldKgUpdate');
const ironPcsUpdate = document.getElementById('ironPcsUpdate');

// Hide all pricing fields for update form
function hideAllPricingUpdate() {
  [membershipFieldsUpdate, jimatFieldsUpdate, washFieldsUpdate, foldingFieldsUpdate, ironingFieldsUpdate].forEach(div => div.style.display = 'none');
}

// Show pricing fields based on selected package for update form
function showPricingFieldsUpdate() {
  hideAllPricingUpdate();
  const packageValue = document.getElementById('pricingServiceUpdate').value;
  if(packageValue==='membership') membershipFieldsUpdate.style.display='block';
  if(packageValue==='jimat') jimatFieldsUpdate.style.display='block';
  if(packageValue==='wash') washFieldsUpdate.style.display='block';
  if(packageValue==='folding') foldingFieldsUpdate.style.display='block';
  if(packageValue==='ironing') ironingFieldsUpdate.style.display='block';
}

// Calculate price for update form
function calcPriceUpdate() {
  const packageValue = document.getElementById('pricingServiceUpdate').value;
  let totalPrice = 0;
  let breakdown = '';

  if(packageValue==='membership') {
    const plan = membershipPlanUpdate.value;
    if(plan==='120-12-60') { totalPrice = 120; breakdown = '$120 (12 trips, 60kg)'; }
    if(plan==='100-2-50') { totalPrice = 100; breakdown = '$100 (2x/week, max 50kg)'; }
  } else if(packageValue==='jimat') {
    const plan = jimatPlanUpdate.value;
    if(plan==='16') { totalPrice = 16; breakdown = '$16 (1 box)'; }
    if(plan==='28') { totalPrice = 28; breakdown = '$28 (2 boxes)'; }
    if(plan==='40') { totalPrice = 40; breakdown = '$40 (4 boxes)'; }
  } else if (packageValue === 'wash') {
    const kg = parseFloat(washKgUpdate.value) || 0;
    if (kg <= 5) {
      totalPrice = 10;
      breakdown = `$10 (up to 5kg)`;
    } else if (kg < 8) {
      // 6 or 7kg
      const addOnKg = kg - 5;
      const addOn = addOnKg * 1.2;
      totalPrice = 10 + addOn;
      breakdown = `$10 (5kg) + $${addOn.toFixed(2)} add-on (${addOnKg}kg × $1.20)`;
    } else if (kg === 8) {
      totalPrice = 12;
      breakdown = `$12 (8kg)`;
    } else if (kg > 8 && kg <= 13) {
      // 9–13kg
      const addOnKg = kg - 8;
      const addOn = addOnKg * 1.2;
      totalPrice = 12 + addOn;
      breakdown = `$12 (8kg) + $${addOn.toFixed(2)} add-on (${addOnKg}kg × $1.20)`;
    } else if (kg > 13) {
      // Above 13kg
      const addOnKg = kg - 13;
      const base = 12 + (5 * 1.2); // $12 + (5kg × $1.20) = $18.00 for 13kg
      const addOn = addOnKg * 1.2;
      totalPrice = base + addOn;
      breakdown = `$18.00 (13kg) + $${addOn.toFixed(2)} add-on (${addOnKg}kg × $1.20)`;
    }
  } else if (packageValue === 'folding') {
    const kg = parseFloat(foldKgUpdate.value) || 0;
    if (kg <= 5) {
      totalPrice = 2;
      breakdown = `$2 (up to 5kg)`;
    } else if (kg === 6 || kg === 7) {
      totalPrice = 2;
      breakdown = `$2 (6/7kg, still $2)`;
    } else if (kg > 7) {
      // Add-on: $1 per every even 2kg above 7kg
      // Only even numbers count, odd kg does not add add-on
      const addOnBlocks = Math.floor((kg - 7) / 2);
      const addOn = addOnBlocks * 1;
      totalPrice = 2 + addOn;
      breakdown = `$2 (7kg) + $${addOn} add-on (${addOnBlocks * 2}kg × $1/2kg)`;
      // For odd kg (e.g. 9kg), the extra kg does not count for add-on
    }
  } else if (packageValue === 'ironing') {
    const pcs = parseFloat(ironPcsUpdate.value) || 0;
    totalPrice = pcs * 1;
    breakdown = `$${totalPrice} (${pcs}pcs × $1)`;
  }

  totalPriceUpdateEl.textContent = `$${totalPrice}`;
  document.getElementById('priceBreakdownUpdate').textContent = breakdown;
}

// Add event listeners for price calculation in update form
if (membershipPlanUpdate) membershipPlanUpdate.addEventListener('change', calcPriceUpdate);
if (jimatPlanUpdate) jimatPlanUpdate.addEventListener('change', calcPriceUpdate);
if (washKgUpdate) washKgUpdate.addEventListener('input', calcPriceUpdate);
if (foldKgUpdate) foldKgUpdate.addEventListener('input', calcPriceUpdate);
if (ironPcsUpdate) ironPcsUpdate.addEventListener('input', calcPriceUpdate);

// Initialize form
hideAllPricingCustomer();
hideAllPricingUpdate();

// ===== NEW: AJAX FORM SUBMISSION =====
document.getElementById('appointmentForm').addEventListener('submit', async function(e) {
  e.preventDefault(); // Prevent default form submission
  
  // Format date fields before submission
  if (document.getElementById('singleDateTime') && document.getElementById('singleDateTime').value) {
    document.getElementById('singleDateFormatted').value = getBruneiFormattedDateTime('singleDateTime');
  }
  if (document.getElementById('pickupDate') && document.getElementById('pickupDate').value) {
    document.getElementById('pickupDateFormatted').value = getBruneiFormattedDateTime('pickupDate');
  }
  if (document.getElementById('deliveryDate') && document.getElementById('deliveryDate').value) {
    document.getElementById('deliveryDateFormatted').value = getBruneiFormattedDateTime('deliveryDate');
  }
  
  // Validate datetime inputs
  if (!validateDateTimeInputs()) {
    return;
  }
  
  // Create form data object
  const formData = new FormData(this);
  
  try {
    // Show loading state (optional)
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Submitting...';
    submitBtn.disabled = true;
    
    // Send data via AJAX to BOTH n8n endpoints
    const [resp1, resp2] = await Promise.all([
    // 1st n8n workflow (uw-admin, KEEPING THIS)
    fetch('https://risetotop.app.n8n.cloud/webhook-test/uw-admin', {
    method: 'POST',
    body: formData
    }),
    // 2nd n8n workflow (CHANGE THIS URL TO YOUR SECOND WEBHOOK)
    fetch('https://risetotop.app.n8n.cloud/webhook-test/uw-driver', {
    method: 'POST',
    body: formData
    
    // Check if the response is OK
    if (response.ok) {
      // Show success message
      document.getElementById('thankYouPopup').style.display = 'flex';
    } else {
      // Handle error response
      throw new Error(`Server returned ${response.status}: ${response.statusText}`);
    }
    
  } catch (error) {
    // Handle any errors
    console.error('Submission error:', error);
    alert('There was an error submitting the form. Please try again.');
  } finally {
    // Restore button state (if needed)
    const submitBtn = this.querySelector('button[type="submit"]');
    if (submitBtn) {
      submitBtn.textContent = 'Submit';
      submitBtn.disabled = false;
    }
  }
});

// Initialize business hours validation
addBusinessHoursValidation();
</script>
</body>
</html>







